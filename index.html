<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ponto e Banco de Horas</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏰</text></svg>">
    <!-- Vuetify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.css" rel="stylesheet">
</head>
<body>
    <div id="app"></div>

    <!-- Vue and Vuetify JS -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify({
            theme: {
                defaultTheme: 'light',
                themes: {
                    light: {
                        colors: {
                            primary: '#4a90e2',
                            secondary: '#f4f7f6',
                            text: '#333',
                            border: '#ddd',
                            success: '#28a745',
                            danger: '#dc3545',
                            neutral: '#6c757d',
                            export: '#6f42c1',
                            finalize: '#fd7e14',
                            absence: '#ffc107',
                            background: '#f4f7f6',
                            surface: '#ffffff',
                        }
                    }
                }
            }
        });

        const app = createApp({
            data() {
                return {
                    // Configurações
                    JORNADA_CONTRATUAL_MINUTOS: (7 * 60) + 20, // 7h20m
                    META_SEMANAL_MINUTOS: 44 * 60,
                    KEY_REGISTROS: 'registrosDePonto',
                    KEY_RESUMOS: 'resumosSemanais',

                    // Form data
                    data: new Date().toISOString().slice(0, 10),
                    inicio: '07:00',
                    saidaIntervalo: '',
                    voltaIntervalo: '',
                    fim: '17:00',

                    // Dados
                    registros: [],
                    resumos: [],
                };
            },
            computed: {
                saldoTotal() {
                    const saldoRegistros = this.registros.reduce((acc, r) => acc + r.saldoDiaMinutos, 0);
                    return this.minsToTime(saldoRegistros);
                },
                saldoTotalClass() {
                    const saldoRegistros = this.registros.reduce((acc, r) => acc + r.saldoDiaMinutos, 0);
                    if (saldoRegistros > 0) return 'text-success';
                    if (saldoRegistros < 0) return 'text-danger';
                    return 'text-neutral';
                },
                horasNaSemana() {
                    const inicioSemanaAtual = this.getInicioDaSemana(new Date());
                    const registros = this.registros.filter(r => !r.finalizado);
                    const daSemana = registros.filter(r => new Date(r.data + 'T00:00:00') >= inicioSemanaAtual);
                    const totalMinutos = daSemana.reduce((acc, r) => acc + r.totalMinutosTrabalhados, 0);
                    return this.minsToTime(totalMinutos);
                },
                registrosAbertos() {
                    return this.registros.filter(r => !r.finalizado);
                },
            },
            methods: {
                // Funções Helper
                timeToMins(t) {
                    if (!t) return 0;
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                },
                minsToTime(m) {
                    if (isNaN(m)) return "00:00";
                    const s = m < 0 ? "-" : "";
                    const a = Math.abs(m);
                    const h = Math.floor(a / 60);
                    const n = Math.round(a % 60);
                    return `${s}${String(h).padStart(2, '0')}:${String(n).padStart(2, '0')}`;
                },
                formatDate(d) {
                    const [a, m, i] = d.split('-');
                    return `${i}/${m}/${a}`;
                },
                getInicioDaSemana(d) {
                    const t = new Date(d);
                    const a = t.getDay();
                    const e = t.getDate() - a + (a === 0 ? -6 : 1);
                    const r = new Date(t.setDate(e));
                    r.setHours(0, 0, 0, 0);
                    return r;
                },
                getWeekId(d) {
                    const date = new Date(d.valueOf());
                    date.setHours(0, 0, 0, 0);
                    date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                    const week1 = new Date(date.getFullYear(), 0, 4);
                    const weekNumber = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                    return `${date.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
                },

                // Acesso aos Dados
                loadData() {
                    this.registros = JSON.parse(localStorage.getItem(this.KEY_REGISTROS) || '[]');
                    this.resumos = JSON.parse(localStorage.getItem(this.KEY_RESUMOS) || '[]');
                },
                saveRegistros() {
                    localStorage.setItem(this.KEY_REGISTROS, JSON.stringify(this.registros.sort((a, b) => new Date(a.data) - new Date(b.data))));
                },
                saveResumos() {
                    localStorage.setItem(this.KEY_RESUMOS, JSON.stringify(this.resumos.sort((a, b) => b.id.localeCompare(a.id))));
                },

                // Lógica Principal
                registrarPonto() {
                    if (!this.data) {
                        alert("Por favor, selecione uma data.");
                        return;
                    }
                    if (this.registros.some(r => r.data === this.data)) {
                        alert('Já existe um registro para esta data.');
                        return;
                    }
                    const inicioMin = this.timeToMins(this.inicio);
                    const saidaMin = this.timeToMins(this.saidaIntervalo);
                    const voltaMin = this.timeToMins(this.voltaIntervalo);
                    const fimMin = this.timeToMins(this.fim);
                    if (fimMin <= inicioMin || voltaMin <= saidaMin) {
                        alert("Os horários parecem estar incorretos.");
                        return;
                    }
                    const totalMins = (saidaMin - inicioMin) + (fimMin - voltaMin);
                    const saldoMins = totalMins - this.JORNADA_CONTRATUAL_MINUTOS;
                    this.registros.push({
                        data: this.data,
                        inicio: this.inicio,
                        saidaIntervalo: this.saidaIntervalo,
                        voltaIntervalo: this.voltaIntervalo,
                        fim: this.fim,
                        totalTrabalhado: this.minsToTime(totalMins),
                        saldoDia: this.minsToTime(saldoMins),
                        totalMinutosTrabalhados: totalMins,
                        saldoDiaMinutos: saldoMins,
                        finalizado: false,
                        type: 'ponto'
                    });
                    this.saveRegistros();
                    alert('Ponto registrado com sucesso!');
                    this.resetForm();
                },
                registrarFalta() {
                    if (!this.data) {
                        alert("Por favor, selecione uma data para registrar a falta.");
                        return;
                    }
                    if (this.registros.some(r => r.data === this.data)) {
                        alert('Já existe um registro para esta data.');
                        return;
                    }
                    const novoRegistro = {
                        data: this.data,
                        type: 'falta',
                        totalMinutosTrabalhados: 0,
                        saldoDiaMinutos: -this.JORNADA_CONTRATUAL_MINUTOS,
                        totalTrabalhado: '00:00',
                        saldoDia: this.minsToTime(-this.JORNADA_CONTRATUAL_MINUTOS),
                        finalizado: false
                    };
                    this.registros.push(novoRegistro);
                    this.saveRegistros();
                    alert(`Falta registrada para ${this.formatDate(this.data)}. O saldo do dia é de ${novoRegistro.saldoDia}.`);
                    this.resetForm();
                },
                finalizarSemanasAnteriores() {
                    const registrosAbertos = this.registros.filter(r => !r.finalizado);
                    if (registrosAbertos.length === 0) {
                        alert("Não há registros em aberto para finalizar.");
                        return;
                    }
                    const weekIdAtual = this.getWeekId(new Date());
                    const semanasParaFinalizar = {};
                    registrosAbertos.forEach(r => {
                        const weekId = this.getWeekId(new Date(r.data + 'T00:00:00'));
                        if (weekId !== weekIdAtual) {
                            if (!semanasParaFinalizar[weekId]) semanasParaFinalizar[weekId] = [];
                            semanasParaFinalizar[weekId].push(r);
                        }
                    });
                    const idsSemanas = Object.keys(semanasParaFinalizar);
                    if (idsSemanas.length === 0) {
                        alert("Nenhuma semana anterior completa para finalizar.");
                        return;
                    }
                    idsSemanas.forEach(id => {
                        const registrosDaSemana = semanasParaFinalizar[id];
                        const totalMinutos = registrosDaSemana.reduce((acc, r) => acc + r.totalMinutosTrabalhados, 0);
                        const saldoSemanalMinutos = totalMinutos - this.META_SEMANAL_MINUTOS;
                        const datas = registrosDaSemana.map(r => new Date(r.data)).sort((a, b) => a - b);
                        const index = this.resumos.findIndex(res => res.id === id);
                        if (index > -1) this.resumos.splice(index, 1);
                        this.resumos.push({
                            id,
                            periodo: `${this.formatDate(datas[0].toISOString().slice(0, 10))} - ${this.formatDate(datas[datas.length - 1].toISOString().slice(0, 10))}`,
                            totalHoras: this.minsToTime(totalMinutos),
                            saldoSemanalMinutos,
                            registros: registrosDaSemana
                        });
                        this.registros.forEach(r => {
                            if (registrosDaSemana.some(reg => reg.data === r.data)) r.finalizado = true;
                        });
                    });
                    this.saveResumos();
                    this.saveRegistros();
                    alert(`${idsSemanas.length} semana(s) finalizada(s) com sucesso!`);
                },
                exportarDados(formato) {
                    if (this.registros.length === 0) {
                        alert('Não há dados para exportar.');
                        return;
                    }
                    let conteudo, mimeType, nomeArquivo;
                    const dataExportacao = new Date().toISOString().slice(0, 10);
                    if (formato === 'csv') {
                        const cabecalho = ['Data', 'Tipo', 'Inicio', 'Saida_Intervalo', 'Volta_Intervalo', 'Fim', 'Total_Trabalhado_HHMM', 'Saldo_Dia_HHMM', 'Finalizado'];
                        const linhas = this.registros.map(r => {
                            const linha = r.type === 'falta'
                                ? [this.formatDate(r.data), r.type, '--', '--', '--', '--', r.totalTrabalhado, r.saldoDia, r.finalizado]
                                : [this.formatDate(r.data), r.type, r.inicio, r.saidaIntervalo, r.voltaIntervalo, r.fim, r.totalTrabalhado, r.saldoDia, r.finalizado];
                            return linha.join(',');
                        }).join('\n');
                        conteudo = [cabecalho.join(','), linhas].join('\n');
                        mimeType = 'text/csv;charset=utf-8;';
                        nomeArquivo = `relatorio_ponto_${dataExportacao}.csv`;
                    } else {
                        conteudo = JSON.stringify({ resumos: this.resumos, registros: this.registros }, null, 2);
                        mimeType = 'application/json;charset=utf-8;';
                        nomeArquivo = `backup_ponto_${dataExportacao}.json`;
                    }
                    const blob = new Blob([conteudo], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nomeArquivo;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                limparDados() {
                    if (confirm('Tem certeza que deseja apagar TODOS os registros e resumos?')) {
                        localStorage.removeItem(this.KEY_REGISTROS);
                        localStorage.removeItem(this.KEY_RESUMOS);
                        this.registros = [];
                        this.resumos = [];
                        alert('Todos os dados foram apagados.');
                    }
                },
                resetForm() {
                    this.data = new Date().toISOString().slice(0, 10);
                    this.inicio = '07:00';
                    this.saidaIntervalo = '';
                    this.voltaIntervalo = '';
                    this.fim = '17:00';
                },
                getSaldoClass(saldoMinutos) {
                    return saldoMinutos >= 0 ? 'text-success' : 'text-danger';
                },
                getRowClass(r) {
                    if (r.type === 'falta') return { backgroundColor: '#fff3cd', color: '#664d03' };
                    return {};
                },
            },
            mounted() {
                this.loadData();
            },
            template: `
                <v-app>
                    <v-main class="bg-background">
                        <v-container class="pa-8" style="max-width: 800px;">
                            <v-card elevation="4" class="pa-6">
                                <h1 class="text-center text-primary mb-2">Controle de Ponto</h1>
                                <v-row class="mb-6">
                                    <v-col cols="12" md="6">
                                        <v-card variant="outlined" class="pa-4 text-center">
                                            <h2 class="text-h6">Saldo do Banco de Horas</h2>
                                            <span class="text-h3 font-weight-bold" :class="saldoTotalClass">{{ saldoTotal }}</span>
                                        </v-card>
                                    </v-col>
                                    <v-col cols="12" md="6">
                                        <v-card variant="outlined" class="pa-4 text-center">
                                            <h2 class="text-h6">Horas na Semana (Atual)</h2>
                                            <span class="text-h3 font-weight-bold text-primary">{{ horasNaSemana }}</span>
                                            <span class="text-body-1 text-neutral"> / 44:00</span>
                                        </v-card>
                                    </v-col>
                                </v-row>
                                <v-form @submit.prevent="registrarPonto">
                                    <v-row>
                                        <v-col cols="12">
                                            <v-text-field v-model="data" label="Data para Registro" type="date" required></v-text-field>
                                        </v-col>
                                    </v-row>
                                    <v-row>
                                        <v-col cols="12" sm="6" md="3">
                                            <v-text-field v-model="inicio" label="Início Expediente" type="time" required></v-text-field>
                                        </v-col>
                                        <v-col cols="12" sm="6" md="3">
                                            <v-text-field v-model="saidaIntervalo" label="Saída Intervalo" type="time" required></v-text-field>
                                        </v-col>
                                        <v-col cols="12" sm="6" md="3">
                                            <v-text-field v-model="voltaIntervalo" label="Volta Intervalo" type="time" required></v-text-field>
                                        </v-col>
                                        <v-col cols="12" sm="6" md="3">
                                            <v-text-field v-model="fim" label="Fim Expediente" type="time" required></v-text-field>
                                        </v-col>
                                    </v-row>
                                    <v-row justify="center" class="mt-4">
                                    <v-btn type="submit" color="primary" class="ma-3 ma-md-0 mr-md-2">Registrar Ponto</v-btn>
                                    <v-btn color="absence" @click="registrarFalta" class="ma-3 ma-md-0">Registrar Falta</v-btn>
                                    </v-row>
                                </v-form>
                                <v-divider class="my-6"></v-divider>
                                <v-row justify="center" v-if="resumos.length > 0 || registrosAbertos.length > 0">
                                    <v-btn color="finalize" class="" @click="finalizarSemanasAnteriores">Finalizar Semana</v-btn>
                                    <v-btn color="export" class="ma-3 my-md-0 ma-md-0 mx-md-2" @click="exportarDados('csv')">Exportar CSV</v-btn>
                                    <v-btn color="danger" @click="limparDados">Limpar Todos os Dados</v-btn>
                                </v-row>
                                <div v-if="resumos.length > 0" class="mt-6">
                                    <h2 class="text-h5 text-center">Resumos Semanais</h2>
                                    <v-expansion-panels>
                                        <v-expansion-panel v-for="resumo in resumos" :key="resumo.id">
                                            <v-expansion-panel-title>
                                                <v-row align="center" justify="space-between">
                                                    <span class="text-body-1 font-weight-bold text-primary">Semana: {{ resumo.periodo }}</span>
                                                    <span class="text-body-1 font-weight-bold">Total: {{ resumo.totalHoras }}</span>
                                                    <span class="text-body-1 font-weight-bold mx-2" :class="getSaldoClass(resumo.saldoSemanalMinutos)">Saldo: {{ minsToTime(resumo.saldoSemanalMinutos) }}</span>
                                                </v-row>
                                            </v-expansion-panel-title>
                                            <v-expansion-panel-text>
                                                <v-table>
                                                    <thead>
                                                        <tr>
                                                            <th>Data</th>
                                                            <th>Início</th>
                                                            <th>Saída Int.</th>
                                                            <th>Volta Int.</th>
                                                            <th>Fim</th>
                                                            <th>Total Trabalhado</th>
                                                            <th>Saldo Dia</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="r in resumo.registros" :key="r.data" :style="getRowClass(r)">
                                                            <td v-if="r.type === 'falta'" colspan="7" class="text-center">AUSÊNCIA REGISTRADA - {{ formatDate(r.data) }} - Total: {{ r.totalTrabalhado }} - Saldo: <strong :class="getSaldoClass(r.saldoDiaMinutos)">{{ r.saldoDia }}</strong></td>
                                                            <td v-else>{{ formatDate(r.data) }}</td>
                                                            <td v-if="r.type !== 'falta'">{{ r.inicio }}</td>
                                                            <td v-if="r.type !== 'falta'">{{ r.saidaIntervalo }}</td>
                                                            <td v-if="r.type !== 'falta'">{{ r.voltaIntervalo }}</td>
                                                            <td v-if="r.type !== 'falta'">{{ r.fim }}</td>
                                                            <td v-if="r.type !== 'falta'">{{ r.totalTrabalhado }}</td>
                                                            <td v-if="r.type !== 'falta'" :class="getSaldoClass(r.saldoDiaMinutos)"><strong>{{ r.saldoDia }}</strong></td>
                                                        </tr>
                                                    </tbody>
                                                </v-table>
                                            </v-expansion-panel-text>
                                        </v-expansion-panel>
                                    </v-expansion-panels>
                                </div>
                                <div v-if="registrosAbertos.length > 0" class="mt-6">
                                    <h2 class="text-h5 text-center">Registros da Semana Atual</h2>
                                    <v-table>
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Início</th>
                                                <th>Saída Int.</th>
                                                <th>Volta Int.</th>
                                                <th>Fim</th>
                                                <th>Total Trabalhado</th>
                                                <th>Saldo Dia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="r in registrosAbertos" :key="r.data" :style="getRowClass(r)">
                                                <td v-if="r.type === 'falta'" colspan="7" class="text-center">AUSÊNCIA REGISTRADA - {{ formatDate(r.data) }} - Total: {{ r.totalTrabalhado }} - Saldo: <strong :class="getSaldoClass(r.saldoDiaMinutos)">{{ r.saldoDia }}</strong></td>
                                                <td v-else>{{ formatDate(r.data) }}</td>
                                                <td v-if="r.type !== 'falta'">{{ r.inicio }}</td>
                                                <td v-if="r.type !== 'falta'">{{ r.saidaIntervalo }}</td>
                                                <td v-if="r.type !== 'falta'">{{ r.voltaIntervalo }}</td>
                                                <td v-if="r.type !== 'falta'">{{ r.fim }}</td>
                                                <td v-if="r.type !== 'falta'">{{ r.totalTrabalhado }}</td>
                                                <td v-if="r.type !== 'falta'" :class="getSaldoClass(r.saldoDiaMinutos)"><strong>{{ r.saldoDia }}</strong></td>
                                            </tr>
                                        </tbody>
                                    </v-table>
                                </div>
                            </v-card>
                        </v-container>
                    </v-main>
                </v-app>
            `
        });

        app.use(vuetify).mount('#app');
    </script>
</body>
</html>