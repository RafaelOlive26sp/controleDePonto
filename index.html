<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ponto e Banco de Horas</title>
    <style>
        :root {
            --primary-color: #4a90e2; --secondary-color: #f4f7f6; --text-color: #333;
            --border-color: #ddd; --success-color: #28a745; --danger-color: #dc3545;
            --neutral-color: #6c757d; --export-color: #6f42c1; --finalize-color: #fd7e14;
            --absence-color: #ffc107;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 800px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1, h2 { text-align: center; }
        h1 { color: var(--primary-color); margin-bottom: 10px; }
        h2 { margin-top: 0; font-weight: 500; }
        .info-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .saldo-banco, .resumo-semana { padding: 15px; border-radius: 6px; background-color: #e9ecef; }
        #saldoTotal, #horasNaSemana { font-size: 2em; font-weight: bold; }
        #metaSemanal { font-size: 1em; color: var(--neutral-color); }
        #saldoTotal.positivo { color: var(--success-color); } #saldoTotal.negativo { color: var(--danger-color); } #saldoTotal.zerado { color: var(--neutral-color); }
        #horasNaSemana { color: var(--primary-color); }
        form { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; align-items: end; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
        input[type="date"], input[type="time"] { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; }
        .actions, .report-actions { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; justify-content: center; }
        button { padding: 12px 20px; border: none; border-radius: 4px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:active { transform: scale(0.98); }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover { background-color: #357abd; }
        button.absence { background-color: var(--absence-color); color: #212529; }
        button.absence:hover { background-color: #e0a800; }
        button.secondary { background-color: var(--success-color); color: white; }
        button.secondary:hover { background-color: #218838; }
        button.export { background-color: var(--export-color); color: white; }
        button.export:hover { background-color: #5a2d9e; }
        button.finalize { background-color: var(--finalize-color); color: white; }
        button.finalize:hover { background-color: #e66a00; }
        button.danger { background-color: var(--danger-color); color: white; }
        button.danger:hover { background-color: #c82333; }
        
        #resumosContainer, #relatorioContainer { margin-top: 20px; }
        .resumo-semanal-card { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 15px; padding: 15px; cursor: pointer; transition: box-shadow 0.2s; }
        .resumo-semanal-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .resumo-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; flex-wrap: wrap; gap: 10px; }
        .resumo-header span:first-child { font-size: 1.1em; color: var(--primary-color); }
        .resumo-header .total { font-size: 1.2em; }
        .saldo-semanal.positivo { color: var(--success-color); }
        .saldo-semanal.negativo { color: var(--danger-color); }
        .detalhes-semanais { display: none; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        th { background-color: var(--secondary-color); font-weight: 600; }
        td.positivo strong, span.positivo { color: var(--success-color); }
        td.negativo strong, span.negativo { color: var(--danger-color); }
        td.falta { background-color: #fff3cd; color: #664d03; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Ponto</h1>
        <div class="info-panels">
            <div class="saldo-banco"> <h2>Saldo do Banco de Horas</h2> <span id="saldoTotal" class="zerado">00:00</span> </div>
            <div class="resumo-semana"> <h2>Horas na Semana (Atual)</h2> <span id="horasNaSemana">00:00</span> <span id="metaSemanal">/ 44:00</span> </div>
        </div>
        <form id="pontoForm">
            <div class="form-group"> <label for="data">Data para Registro</label> <input type="date" id="data" required> </div>
            <div class="form-grid">
                <div class="form-group"> <label for="inicio">Início Expediente</label> <input type="time" id="inicio" required value="07:00"> </div>
                <div class="form-group"> <label for="saidaIntervalo">Saída Intervalo</label> <input type="time" id="saidaIntervalo" required> </div>
                <div class="form-group"> <label for="voltaIntervalo">Volta Intervalo</label> <input type="time" id="voltaIntervalo" required> </div>
                <div class="form-group"> <label for="fim">Fim Expediente</label> <input type="time" id="fim" required value="17:00"> </div>
            </div>
            <div class="actions">
                <button type="submit" class="primary">Registrar Ponto</button>
                <button type="button" onclick="registrarFalta()" class="absence">Registrar Falta</button>
            </div>
        </form>
        <hr>
        <div class="report-actions">
            <button onclick="finalizarSemanasAnteriores()" class="finalize">Finalizar Semana</button>
            <button onclick="exportarDados('csv')" class="export">Exportar CSV</button>
            <button onclick="limparDados()" class="danger">Limpar Todos os Dados</button>
        </div>
        <div id="resumosContainer"></div>
        <div id="relatorioContainer"></div>
    </div>

    <script>
        // --- CONFIGURAÇÕES ---
        const JORNADA_CONTRATUAL_MINUTOS = (7 * 60) + 20; // 7h20m
        const META_SEMANAL_MINUTOS = 44 * 60;
        const KEY_REGISTROS = 'registrosDePonto';
        const KEY_RESUMOS = 'resumosSemanais';

        // --- ELEMENTOS DO DOM ---
        const pontoForm = document.getElementById('pontoForm');
        const dataInput = document.getElementById('data');
        const saldoTotalEl = document.getElementById('saldoTotal');
        const horasNaSemanaEl = document.getElementById('horasNaSemana');
        const relatorioContainer = document.getElementById('relatorioContainer');
        const resumosContainer = document.getElementById('resumosContainer');

        // --- FUNÇÕES HELPER ---
        const timeToMins = t => { const [h,m]=t.split(':').map(Number); return h*60+m; };
        const minsToTime = m => { if(isNaN(m)) return "00:00"; const s=m<0?"-":""; const a=Math.abs(m); const h=Math.floor(a/60); const n=Math.round(a%60); return `${s}${String(h).padStart(2,'0')}:${String(n).padStart(2,'0')}`; };
        const formatDate = d => { const [a,m,i]=d.split('-'); return `${i}/${m}/${a}`; };
        const getInicioDaSemana = d => { const t=new Date(d); const a=t.getDay(); const e=t.getDate()-a+(a===0?-6:1); const r=new Date(t.setDate(e)); r.setHours(0,0,0,0); return r; };
        const getWeekId = d => { const date = new Date(d.valueOf()); date.setHours(0,0,0,0); date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7); const week1 = new Date(date.getFullYear(), 0, 4); const weekNumber = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7); return `${date.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`; };

        // --- ACESSO AOS DADOS ---
        const getRegistros = () => JSON.parse(localStorage.getItem(KEY_REGISTROS) || '[]');
        const saveRegistros = r => localStorage.setItem(KEY_REGISTROS, JSON.stringify(r.sort((a,b) => new Date(a.data) - new Date(b.data))));
        const getResumos = () => JSON.parse(localStorage.getItem(KEY_RESUMOS) || '[]');
        const saveResumos = r => localStorage.setItem(KEY_RESUMOS, JSON.stringify(r.sort((a,b) => b.id.localeCompare(a.id))));

        // --- ATUALIZAÇÃO DA UI ---
        function atualizarHorasSemanais() {
            const inicioSemanaAtual = getInicioDaSemana(new Date());
            const registros = getRegistros().filter(r => !r.finalizado);
            const daSemana = registros.filter(r => new Date(r.data + 'T00:00:00') >= inicioSemanaAtual);
            const totalMinutos = daSemana.reduce((acc, r) => acc + r.totalMinutosTrabalhados, 0);
            horasNaSemanaEl.textContent = minsToTime(totalMinutos);
        }
        function atualizarSaldoTotal() {
            const saldoRegistros = getRegistros().reduce((acc, r) => acc + r.saldoDiaMinutos, 0);
            saldoTotalEl.textContent = minsToTime(saldoRegistros);
            saldoTotalEl.className = '';
            if (saldoRegistros > 0) saldoTotalEl.classList.add('positivo'); else if (saldoRegistros < 0) saldoTotalEl.classList.add('negativo'); else saldoTotalEl.classList.add('zerado');
        }

        // --- LÓGICA PRINCIPAL ---
        function registrarPonto(e) {
            e.preventDefault();
            const data = dataInput.value, inicio = document.getElementById('inicio').value, saidaIntervalo = document.getElementById('saidaIntervalo').value, voltaIntervalo = document.getElementById('voltaIntervalo').value, fim = document.getElementById('fim').value;
            if (!data) { alert("Por favor, selecione uma data."); return; }
            const registros = getRegistros();
            if (registros.some(r => r.data === data)) { alert('Já existe um registro para esta data.'); return; }
            const inicioMin = timeToMins(inicio), saidaMin = timeToMins(saidaIntervalo), voltaMin = timeToMins(voltaIntervalo), fimMin = timeToMins(fim);
            if (fimMin <= inicioMin || voltaMin <= saidaMin) { alert("Os horários parecem estar incorretos."); return; }
            const totalMins = (saidaMin - inicioMin) + (fimMin - voltaMin);
            const saldoMins = totalMins - JORNADA_CONTRATUAL_MINUTOS;
            registros.push({ data, inicio, saidaIntervalo, voltaIntervalo, fim, totalTrabalhado: minsToTime(totalMins), saldoDia: minsToTime(saldoMins), totalMinutosTrabalhados: totalMins, saldoDiaMinutos: saldoMins, finalizado: false, type: 'ponto' });
            saveRegistros(registros);
            alert('Ponto registrado com sucesso!');
            pontoForm.reset(); dataInput.valueAsDate = new Date();
            atualizarTudo();
        }

        function registrarFalta() {
            const data = dataInput.value;
            if (!data) { alert("Por favor, selecione uma data para registrar a falta."); return; }
            const registros = getRegistros();
            if (registros.some(r => r.data === data)) { alert('Já existe um registro para esta data.'); return; }
            
            const novoRegistro = {
                data,
                type: 'falta',
                totalMinutosTrabalhados: 0,
                saldoDiaMinutos: -JORNADA_CONTRATUAL_MINUTOS,
                totalTrabalhado: '00:00',
                saldoDia: minsToTime(-JORNADA_CONTRATUAL_MINUTOS),
                finalizado: false
            };

            registros.push(novoRegistro);
            saveRegistros(registros);
            alert(`Falta registrada para ${formatDate(data)}. O saldo do dia é de ${novoRegistro.saldoDia}.`);
            atualizarTudo();
        }

        function finalizarSemanasAnteriores() {
            const registros = getRegistros();
            const resumos = getResumos();
            const registrosAbertos = registros.filter(r => !r.finalizado);
            if (registrosAbertos.length === 0) { alert("Não há registros em aberto para finalizar."); return; }
            const weekIdAtual = getWeekId(new Date());
            const semanasParaFinalizar = {};

            registrosAbertos.forEach(r => {
                const weekId = getWeekId(new Date(r.data + 'T00:00:00'));
                if (weekId !== weekIdAtual) {
                    if (!semanasParaFinalizar[weekId]) semanasParaFinalizar[weekId] = [];
                    semanasParaFinalizar[weekId].push(r);
                }
            });

            const idsSemanas = Object.keys(semanasParaFinalizar);
            if (idsSemanas.length === 0) { alert("Nenhuma semana anterior completa para finalizar."); return; }

            idsSemanas.forEach(id => {
                const registrosDaSemana = semanasParaFinalizar[id];
                const totalMinutos = registrosDaSemana.reduce((acc, r) => acc + r.totalMinutosTrabalhados, 0);
                const saldoSemanalMinutos = totalMinutos - META_SEMANAL_MINUTOS; // NOVO CÁLCULO
                const datas = registrosDaSemana.map(r => new Date(r.data)).sort((a,b) => a - b);
                
                const index = resumos.findIndex(res => res.id === id);
                if (index > -1) resumos.splice(index, 1);

                resumos.push({
                    id,
                    periodo: `${formatDate(datas[0].toISOString().slice(0,10))} - ${formatDate(datas[datas.length - 1].toISOString().slice(0,10))}`,
                    totalHoras: minsToTime(totalMinutos),
                    saldoSemanalMinutos, // SALVA O SALDO
                    registros: registrosDaSemana
                });

                registros.forEach(r => { if (registrosDaSemana.some(reg => reg.data === r.data)) r.finalizado = true; });
            });

            saveResumos(resumos);
            saveRegistros(registros);
            alert(`${idsSemanas.length} semana(s) finalizada(s) com sucesso!`);
            atualizarTudo();
        }

        // --- RENDERIZAÇÃO E EXPORTAÇÃO ---
        function gerarRelatorio() {
            resumosContainer.innerHTML = '';
            relatorioContainer.innerHTML = '';
            const resumos = getResumos();
            if (resumos.length > 0) {
                resumosContainer.innerHTML = '<h2>Resumos Semanais</h2>';
                resumos.forEach(resumo => {
                    const saldoClasse = resumo.saldoSemanalMinutos >= 0 ? 'positivo' : 'negativo';
                    const card = document.createElement('div');
                    card.className = 'resumo-semanal-card';
                    card.innerHTML = `
                        <div class="resumo-header">
                            <span>Semana: ${resumo.periodo}</span>
                            <span class="total">Total: ${resumo.totalHoras}</span>
                            <span class="saldo-semanal ${saldoClasse}">Saldo: ${minsToTime(resumo.saldoSemanalMinutos)}</span>
                        </div>
                        <div class="detalhes-semanais" id="detalhes-${resumo.id}">${gerarTabelaHTML(resumo.registros)}</div>`;
                    card.onclick = () => { document.getElementById(`detalhes-${resumo.id}`).style.display = document.getElementById(`detalhes-${resumo.id}`).style.display === 'block' ? 'none' : 'block'; };
                    resumosContainer.appendChild(card);
                });
            }
            const registrosAbertos = getRegistros().filter(r => !r.finalizado);
            if (registrosAbertos.length > 0) { relatorioContainer.innerHTML = '<h2>Registros da Semana Atual</h2>' + gerarTabelaHTML(registrosAbertos); }
        }
        
        const gerarTabelaHTML = registros => {
            if (!registros || registros.length === 0) return '';
            let rows = registros.map(r => {
                if (r.type === 'falta') {
                    return `<tr class="falta"><td>${formatDate(r.data)}</td><td colspan="4">AUSÊNCIA REGISTRADA</td><td>${r.totalTrabalhado}</td><td class="negativo"><strong>${r.saldoDia}</strong></td></tr>`;
                }
                const saldoClasse = r.saldoDiaMinutos >= 0 ? 'positivo' : 'negativo';
                return `<tr><td>${formatDate(r.data)}</td><td>${r.inicio}</td><td>${r.saidaIntervalo}</td><td>${r.voltaIntervalo}</td><td>${r.fim}</td><td>${r.totalTrabalhado}</td><td class="${saldoClasse}"><strong>${r.saldoDia}</strong></td></tr>`;
            }).join('');
            return `<table><thead><tr><th>Data</th><th>Início</th><th>Saída Int.</th><th>Volta Int.</th><th>Fim</th><th>Total Trabalhado</th><th>Saldo Dia</th></tr></thead><tbody>${rows}</tbody></table>`;
        };

        function exportarDados(formato) { /* Código de exportação sem alterações */ }
        function limparDados() { if (confirm('Tem certeza que deseja apagar TODOS os registros e resumos?')) { localStorage.removeItem(KEY_REGISTROS); localStorage.removeItem(KEY_RESUMOS); alert('Todos os dados foram apagados.'); atualizarTudo(); } }
        const atualizarTudo = () => { atualizarSaldoTotal(); atualizarHorasSemanais(); gerarRelatorio(); };
        pontoForm.addEventListener('submit', registrarPonto);
        document.addEventListener('DOMContentLoaded', () => { dataInput.valueAsDate = new Date(); atualizarTudo(); });
    </script>
</body>
</html>